// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                   @id @default(uuid())
  email                  String                   @unique
  role                   UserRole                 @default(user)
  tribeId                String?
  state                  String?
  birthYear              Int?
  tags                   String[]                 @default([])
  saved                  SavedResource[]
  applications           ScholarshipApplication[]
  resourceReviews        ResourceReview[]
  scholarshipReviews     ScholarshipReview[]
  createdAt              DateTime                 @default(now())
  deletedAt              DateTime?

  @@index([email])
  @@index([state])
  @@index([tribeId])
  @@index([deletedAt])
}

model Tribe {
  id                        String     @id @default(uuid())
  name                      String
  federalRecognitionStatus  String?
  website                   String?
  languageLinks             String[]
  enrollmentOffice          String?
  region                    String?
  programs                  Resource[]
  lastUpdated               DateTime   @default(now())
  deletedAt                 DateTime?

  @@index([name])
  @@index([region])
  @@index([deletedAt])
}

model Resource {
  id                    String           @id @default(uuid())
  type                  ResourceType
  title                 String
  description           String
  url                   String?          @unique
  eligibility           String[]
  tags                  String[]
  state                 String?
  tribeId               String?
  tribe                 Tribe?           @relation(fields: [tribeId], references: [id])
  saved                 SavedResource[]
  reviews               ResourceReview[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  deletedAt             DateTime?
  source                String?
  lastVerified          DateTime?
  verifiedBy            String?

  // Enhanced fields for better UX
  applicationProcess    String?          // Step-by-step guide
  requiredDocuments     String[]         @default([]) // List of required docs
  processingTime        String?          // e.g., "2-4 weeks"
  contactPhone          String?
  contactEmail          String?
  officeHours           String?
  languageSupport       String[]         @default([]) // ["English", "Navajo", etc.]
  videoUrl              String?          // Tutorial/info video
  averageAward          String?          // For financial assistance programs
  recipientsPerYear     Int?             // How many people helped annually
  renewalRequired       Boolean?         @default(false)
  renewalDeadline       DateTime?
  difficulty            Difficulty?      @default(moderate) // Application difficulty
  featured              Boolean          @default(false) // Featured resources

  @@index([state])
  @@index([tribeId])
  @@index([type])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([type, state, deletedAt])
  @@index([lastVerified])
  @@index([featured])
  @@index([difficulty])
}

model Scholarship {
  id                    String                   @id @default(uuid())
  name                  String
  amount                String?
  deadline              DateTime?
  description           String
  tags                  String[]
  eligibility           String[]
  url                   String?                  @unique
  source                String?
  applications          ScholarshipApplication[]
  reviews               ScholarshipReview[]
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  deletedAt             DateTime?
  lastVerified          DateTime?
  verifiedBy            String?

  // Enhanced fields
  essayRequired         Boolean?                 @default(false)
  letterOfRecRequired   Int?                     // Number of recommendation letters
  minGPA                Float?
  specificMajors        String[]                 @default([]) // Required or preferred majors
  tribalEnrollmentReq   Boolean?                 @default(false)
  recipientsPerYear     Int?
  renewalEligibility    Boolean?                 @default(false)
  contactEmail          String?
  contactPhone          String?
  applicationProcess    String?                  // Step-by-step guide
  requiredDocuments     String[]                 @default([])
  videoUrl              String?
  featured              Boolean                  @default(false)
  amountMin             Int?                     // For range filtering
  amountMax             Int?

  @@index([deadline])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([deadline, deletedAt])
  @@index([lastVerified])
  @@index([featured])
  @@index([featured, deadline])
  @@index([minGPA])
  @@index([amountMin, amountMax])
}

model SavedResource {
  id          String   @id @default(uuid())
  userId      String
  resourceId  String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
}

model ChangeLog {
  id             String   @id @default(uuid())
  source         String?
  type           String
  originalValue  String?
  updatedValue   String?
  aiConfidence   Float?
  approved       Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([approved])
  @@index([createdAt])
  @@index([approved, createdAt])
}

model ScholarshipApplication {
  id              String              @id @default(uuid())
  userId          String
  scholarshipId   String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  scholarship     Scholarship         @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
  status          ApplicationStatus   @default(interested)
  applicationDate DateTime?
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([userId, scholarshipId])
  @@index([userId])
  @@index([scholarshipId])
  @@index([status])
}

model ResourceReview {
  id          String   @id @default(uuid())
  userId      String
  resourceId  String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  rating      Int      // 1-5 stars
  comment     String?
  helpful     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, resourceId])
  @@index([resourceId])
  @@index([rating])
  @@index([createdAt])
}

model ScholarshipReview {
  id             String      @id @default(uuid())
  userId         String
  scholarshipId  String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  scholarship    Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
  rating         Int         // 1-5 stars
  comment        String?
  wasAwarded     Boolean?
  helpful        Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([userId, scholarshipId])
  @@index([scholarshipId])
  @@index([rating])
  @@index([wasAwarded])
  @@index([createdAt])
}

enum ResourceType {
  federal
  state
  tribal
  scholarship
  emergency
}

enum UserRole {
  user
  admin
}

enum ApplicationStatus {
  interested
  researching
  preparing
  submitted
  accepted
  rejected
  withdrawn
}

enum Difficulty {
  simple
  moderate
  complex
}

model ResourceGuide {
  id            String   @id @default(uuid())
  slug          String   @unique
  title         String
  description   String
  content       String   // Markdown content
  category      String   // "benefits", "enrollment", "eligibility", "state-guide"
  icon          String?  // Icon identifier
  author        String?
  readTime      Int?     // Reading time in minutes
  published     Boolean  @default(false)
  featured      Boolean  @default(false)
  viewCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([category])
  @@index([published])
  @@index([featured])
}

model SuccessStory {
  id            String   @id @default(uuid())
  slug          String   @unique
  name          String   // Person's name or "Anonymous"
  tribe         String?  // Tribal affiliation
  location      String?  // State or general location
  title         String   // Story title
  excerpt       String   // Short summary
  content       String   // Full story (markdown)
  category      String   // "scholarship", "resource", "program", "general"
  resourceType  String?  // Related resource type
  imageUrl      String?  // Optional photo
  testimonial   String?  // Pull quote
  published     Boolean  @default(false)
  featured      Boolean  @default(false)
  viewCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([category])
  @@index([published])
  @@index([featured])
}

model FAQ {
  id            String   @id @default(uuid())
  question      String
  answer        String   // Markdown content
  category      String   // "eligibility", "application", "deadlines", "general"
  order         Int      @default(0) // For manual sorting
  helpful       Int      @default(0) // Helpful vote count
  notHelpful    Int      @default(0) // Not helpful vote count
  published     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([published])
  @@index([order])
}

model BlogPost {
  id            String   @id @default(uuid())
  slug          String   @unique
  title         String
  excerpt       String
  content       String   // Markdown content
  category      String   // "news", "updates", "policy", "deadline", "community"
  tags          String[]
  author        String
  imageUrl      String?  // Featured image
  published     Boolean  @default(false)
  featured      Boolean  @default(false)
  viewCount     Int      @default(0)
  publishedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([category])
  @@index([published])
  @@index([featured])
  @@index([publishedAt])
}

model ResourceReport {
  id            String        @id @default(uuid())
  resourceId    String
  resourceTitle String
  reason        String
  status        ReportStatus  @default(pending)
  reviewedBy    String?       // Admin who reviewed the report
  reviewedAt    DateTime?
  notes         String?       // Admin notes
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([resourceId])
  @@index([status])
  @@index([createdAt])
}

enum ReportStatus {
  pending
  reviewed
  resolved
  dismissed
}

model Grant {
  id                    String         @id @default(uuid())
  name                  String
  description           String
  url                   String?        @unique
  fundingAgency         String?        // e.g., "Bureau of Indian Affairs", "HUD", "USDA"
  grantType             GrantType      @default(federal)
  amount                String?        // e.g., "$50,000 - $500,000"
  amountMin             Int?
  amountMax             Int?
  deadline              DateTime?
  eligibility           String[]
  tags                  String[]
  eligibleApplicants    String[]       @default([]) // e.g., ["Tribes", "Tribal Organizations", "Native Nonprofits"]
  applicationProcess    String?
  requiredDocuments     String[]       @default([])
  contactEmail          String?
  contactPhone          String?
  cfda                  String?        // Catalog of Federal Domestic Assistance number
  opportunityNumber     String?        // Grants.gov opportunity number
  matchingRequired      Boolean?       @default(false)
  matchingPercentage    Float?         // e.g., 25 for 25% match required
  renewalEligibility    Boolean?       @default(false)
  recipientsPerYear     Int?
  featured              Boolean        @default(false)
  source                String?
  lastVerified          DateTime?
  verifiedBy            String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  deletedAt             DateTime?

  @@index([grantType])
  @@index([deadline])
  @@index([fundingAgency])
  @@index([deletedAt])
  @@index([featured])
  @@index([createdAt])
  @@index([amountMin, amountMax])
}

enum GrantType {
  federal
  state
  tribal
  foundation
  corporate
}
